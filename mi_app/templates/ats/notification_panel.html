{% extends "ats/base_ats.html" %}
{% load static %}

{% block ats_title %}Notificaciones{% endblock %}
{% block ats_header_title %}Notificaciones{% endblock %}

{% block ats_extra_css %}
  .notif-messages-wrap {
    max-width: 960px;
    margin: 0 auto;
    color: var(--default-color);
  }
  .notif-messages-card {
    background: var(--surface-color);
    border-radius: 16px;
    border: 1px solid rgba(0,196,201,0.12);
    box-shadow: 0 4px 24px rgba(11,28,45,0.06);
    overflow: hidden;
    display: flex;
    flex-direction: column;
    min-height: 480px;
  }
  @media (min-width: 768px) {
    .notif-messages-card { min-height: 520px; }
  }
  .notif-messages-header {
    width: 100%;
    flex-shrink: 0;
    padding: 1.25rem 1.5rem;
    border-bottom: 1px solid rgba(11,28,45,0.08);
    background: rgba(0,196,201,0.04);
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
  }
  .notif-messages-header h1 { font-family: var(--ats-heading); font-size: 1.25rem; font-weight: 800; color: var(--heading-color); margin: 0 0 0.2rem; }
  .notif-messages-header .sub { font-size: 0.85rem; color: var(--default-color); opacity: 0.85; margin: 0; }
  .notif-messages-header .actions { display: flex; align-items: center; gap: 0.5rem; }
  .notif-messages-header .actions .btn { border-radius: 10px; font-weight: 600; font-size: 0.875rem; }
  .notif-two-col { display: flex; flex-direction: column; flex: 1; min-height: 0; }
  @media (min-width: 768px) { .notif-two-col { flex-direction: row; } }
  .notif-list-col {
    width: 100%;
    border-right: none;
    border-bottom: 1px solid rgba(11,28,45,0.08);
    display: flex;
    flex-direction: column;
    min-height: 240px;
  }
  @media (min-width: 768px) {
    .notif-list-col { width: 320px; min-width: 320px; border-right: 1px solid rgba(11,28,45,0.08); border-bottom: none; min-height: 0; }
  }
  .notif-list-col .col-head {
    padding: 0.75rem 1rem;
    font-size: 0.8rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.04em;
    color: var(--default-color);
    opacity: 0.8;
    border-bottom: 1px solid rgba(11,28,45,0.06);
    flex-shrink: 0;
  }
  .notif-list-col .notif-list-scroll {
    overflow-y: auto;
    flex: 1;
    min-height: 0;
    max-height: 380px;
  }
  .notif-list-col .notif-list-scroll::-webkit-scrollbar { width: 8px; }
  .notif-list-col .notif-list-scroll::-webkit-scrollbar-track { background: rgba(11,28,45,0.06); border-radius: 4px; }
  .notif-list-col .notif-list-scroll::-webkit-scrollbar-thumb { background: rgba(0,196,201,0.35); border-radius: 4px; }
  .notif-list-col .notif-list-scroll::-webkit-scrollbar-thumb:hover { background: rgba(0,196,201,0.5); }
  .notif-list { padding: 0; margin: 0; list-style: none; }
  .notif-item {
    border-bottom: 1px solid rgba(11,28,45,0.06);
    transition: background 0.15s;
    cursor: pointer;
  }
  .notif-item:last-child { border-bottom: none; }
  .notif-item:hover { background: rgba(0,196,201,0.06); }
  .notif-item.active { background: rgba(0,196,201,0.1); border-left: 3px solid var(--accent-color); }
  .notif-item.unread .notif-item-inner { background: rgba(0,196,201,0.05); }
  .notif-item.unread:hover .notif-item-inner { background: rgba(0,196,201,0.08); }
  .notif-item .notif-item-inner {
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
    padding: 0.9rem 1rem;
    text-decoration: none;
    color: inherit;
  }
  .notif-item .notif-icon {
    width: 40px;
    height: 40px;
    min-width: 40px;
    border-radius: 10px;
    background: rgba(0,196,201,0.12);
    color: var(--accent-color);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.1rem;
  }
  .notif-item.unread .notif-icon { background: rgba(0,196,201,0.18); }
  .notif-item .notif-body { flex: 1; min-width: 0; }
  .notif-item .notif-title {
    font-weight: 700;
    font-size: 0.9rem;
    color: var(--heading-color);
    margin-bottom: 0.2rem;
    display: -webkit-box;
    -webkit-line-clamp: 1;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  .notif-item .notif-time {
    font-size: 0.75rem;
    color: var(--default-color);
    opacity: 0.75;
  }
  .notif-item .notif-unread-dot {
    width: 8px;
    height: 8px;
    min-width: 8px;
    border-radius: 50%;
    background: var(--accent-color);
    margin-top: 0.4rem;
    flex-shrink: 0;
  }
  .notif-detail-col {
    flex: 1;
    display: flex;
    flex-direction: column;
    min-height: 280px;
    background: rgba(11,28,45,0.02);
  }
  @media (min-width: 768px) { .notif-detail-col { min-height: 0; } }
  .notif-detail-placeholder {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 2rem;
    text-align: center;
    color: var(--default-color);
    opacity: 0.85;
  }
  .notif-detail-placeholder .icon-wrap {
    width: 72px;
    height: 72px;
    border-radius: 50%;
    background: rgba(0,196,201,0.1);
    color: var(--accent-color);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2rem;
    margin-bottom: 1rem;
  }
  .notif-detail-placeholder h3 {
    font-family: var(--ats-heading);
    font-size: 1.05rem;
    font-weight: 700;
    color: var(--heading-color);
    margin-bottom: 0.35rem;
  }
  .notif-detail-placeholder p { margin: 0; font-size: 0.9rem; }
  .notif-detail-content {
    flex: 1;
    padding: 1.5rem;
    display: none;
    flex-direction: column;
  }
  .notif-detail-content.show { display: flex; }
  .notif-detail-content .detail-title {
    font-family: var(--ats-heading);
    font-size: 1.15rem;
    font-weight: 700;
    color: var(--heading-color);
    margin-bottom: 0.5rem;
  }
  .notif-detail-content .detail-meta {
    font-size: 0.85rem;
    color: var(--default-color);
    opacity: 0.8;
    margin-bottom: 1rem;
  }
  .notif-detail-content .detail-message {
    font-size: 0.95rem;
    color: var(--default-color);
    line-height: 1.5;
    margin-bottom: 1.5rem;
    flex: 1;
  }
  .notif-detail-content .detail-cta .btn {
    border-radius: 10px;
    font-weight: 600;
    padding: 0.5rem 1.25rem;
  }
  .notif-pagination {
    padding: 0.75rem 1rem;
    border-top: 1px solid rgba(11,28,45,0.08);
    background: rgba(11,28,45,0.02);
    flex-shrink: 0;
  }
  .notif-pagination .pagination { margin: 0; justify-content: center; }
  .notif-pagination .page-link { border-radius: 8px; font-size: 0.875rem; }
  .notif-empty-list {
    padding: 2rem 1rem;
    text-align: center;
    color: var(--default-color);
    opacity: 0.85;
    font-size: 0.9rem;
  }
{% endblock %}

{% block ats_content %}
  <div class="notif-messages-wrap">
    <div class="notif-messages-card">
      <div class="notif-messages-header">
        <div>
          <h1>Notificaciones</h1>
          <p class="sub">Centro de notificaciones</p>
        </div>
        <div class="actions">
          {% if ats_unread_count > 0 %}
          <form method="post" action="{% url 'ats_notification_panel' %}" class="d-inline">
            {% csrf_token %}
            <button type="submit" class="btn btn-outline-primary btn-sm">Marcar todas como leídas</button>
          </form>
          {% endif %}
          <a href="{% url 'ats_dashboard' %}" class="btn btn-sm btn-outline-secondary">Ir al panel</a>
        </div>
      </div>

      <div class="notif-two-col">
        <!-- Columna izquierda: lista -->
        <div class="notif-list-col">
          <div class="col-head">Mensajes</div>
          {% if notifications %}
          <div class="notif-list-scroll">
            <ul class="notif-list" id="notifList">
              {% for n in notifications %}
              <li class="notif-item {% if not n.read %}unread{% endif %}" data-pk="{{ n.pk }}" data-title="{{ n.title|default:'' }}" data-message="{{ n.message|default:'' }}" data-created="{{ n.created_at|date:'d/m/Y H:i' }}" data-go-url="{% url 'ats_notification_go' n.pk %}">
                <div class="notif-item-inner">
                  <div class="notif-icon"><i class="bi bi-bell-fill"></i></div>
                  <div class="notif-body">
                    <div class="notif-title">{{ n.title }}</div>
                    <div class="notif-time">{{ n.created_at|timesince }} atrás</div>
                  </div>
                  {% if not n.read %}<div class="notif-unread-dot" aria-hidden="true"></div>{% endif %}
                </div>
              </li>
              {% endfor %}
            </ul>
          </div>
          {% if page_obj.has_other_pages %}
          <nav class="notif-pagination" aria-label="Paginación">
            <ul class="pagination pagination-sm mb-0">
              {% if page_obj.has_previous %}<li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}">Anterior</a></li>{% endif %}
              <li class="page-item disabled"><span class="page-link">{{ page_obj.number }} / {{ page_obj.paginator.num_pages }}</span></li>
              {% if page_obj.has_next %}<li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}">Siguiente</a></li>{% endif %}
            </ul>
          </nav>
          {% endif %}
          {% else %}
          <div class="notif-empty-list">No hay notificaciones.</div>
          {% endif %}
        </div>

        <!-- Columna derecha: detalle o placeholder -->
        <div class="notif-detail-col">
          <div class="notif-detail-placeholder" id="notifPlaceholder">
            <div class="icon-wrap"><i class="bi bi-cursor"></i></div>
            <h3>Selecciona una notificación</h3>
            <p>Elige una en la lista de la izquierda para ver el detalle</p>
          </div>
          <div class="notif-detail-content" id="notifDetail">
            <div class="detail-title" id="detailTitle"></div>
            <div class="detail-meta" id="detailMeta"></div>
            <div class="detail-message" id="detailMessage"></div>
            <div class="detail-cta">
              <a href="#" id="detailGoBtn" class="btn btn-primary">Ir al enlace</a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
  (function() {
    var list = document.getElementById('notifList');
    var placeholder = document.getElementById('notifPlaceholder');
    var detail = document.getElementById('notifDetail');
    var detailTitle = document.getElementById('detailTitle');
    var detailMeta = document.getElementById('detailMeta');
    var detailMessage = document.getElementById('detailMessage');
    var detailGoBtn = document.getElementById('detailGoBtn');

    if (!list) return;

    function escapeHtml(str) {
      if (!str) return '';
      var div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    function selectItem(item) {
      var pk = item.getAttribute('data-pk');
      var title = item.getAttribute('data-title');
      var message = item.getAttribute('data-message');
      var created = item.getAttribute('data-created');
      var goUrl = item.getAttribute('data-go-url');

      list.querySelectorAll('.notif-item').forEach(function(el) { el.classList.remove('active'); });
      item.classList.add('active');

      detailTitle.textContent = title || '';
      detailMeta.textContent = created || '';
      detailMessage.textContent = message || '(Sin mensaje)';
      detailMessage.style.display = message ? 'block' : 'block';
      detailGoBtn.href = goUrl || '#';

      placeholder.classList.remove('d-flex');
      placeholder.style.display = 'none';
      detail.classList.add('show');
    }

    list.querySelectorAll('.notif-item').forEach(function(item) {
      item.addEventListener('click', function(e) {
        e.preventDefault();
        selectItem(item);
      });
    });

    // Auto-seleccionar la primera notificación si existe
    var first = list.querySelector('.notif-item');
    if (first) selectItem(first);
  })();
  </script>
{% endblock %}
